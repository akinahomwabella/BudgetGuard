<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetGuard Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .input-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.9em;
        }

        .input-group input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .categories-section {
            margin-top: 20px;
        }

        .category-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }

        .btn {
            padding: 12px 30px;
            font-size: 1em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .results-section {
            margin-top: 30px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .metric-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric-card .value {
            font-size: 2em;
            font-weight: 700;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1> BudgetGuard Dashboard</h1>
            <p>FlowCast</p>
        </div>

        <div class="content">
            <div class="input-section">
                <h2>Financial Parameters</h2>
                <div class="input-grid">
                    <div class="input-group">
                        <label for="initial-balance">Initial Balance ($)</label>
                        <input type="number" id="initial-balance" value="5000" step="100">
                    </div>
                    <div class="input-group">
                        <label for="monthly-income">Monthly Income ($)</label>
                        <input type="number" id="monthly-income" value="4500" step="100">
                    </div>
                    <div class="input-group">
                        <label for="savings-goal">Savings Goal ($)</label>
                        <input type="number" id="savings-goal" value="3000" step="100">
                    </div>
                    <div class="input-group">
                        <label for="forecast-days">Forecast Days</label>
                        <input type="number" id="forecast-days" value="60" min="1" max="365">
                    </div>
                </div>

                <div class="categories-section">
                    <h3 style="margin-bottom: 15px;">Expense Categories</h3>
                    <div class="category-row">
                        <div class="input-group">
                            <label>Category</label>
                            <input type="text" value="Housing" readonly>
                        </div>
                        <div class="input-group">
                            <label>Mean ($)</label>
                            <input type="number" class="cat-mean" value="1500" step="10">
                        </div>
                        <div class="input-group">
                            <label>Std Dev ($)</label>
                            <input type="number" class="cat-std" value="50" step="5">
                        </div>
                    </div>
                    <div class="category-row">
                        <div class="input-group">
                            <input type="text" value="Groceries" readonly>
                        </div>
                        <div class="input-group">
                            <input type="number" class="cat-mean" value="400" step="10">
                        </div>
                        <div class="input-group">
                            <input type="number" class="cat-std" value="100" step="5">
                        </div>
                    </div>
                    <div class="category-row">
                        <div class="input-group">
                            <input type="text" value="Dining" readonly>
                        </div>
                        <div class="input-group">
                            <input type="number" class="cat-mean" value="300" step="10">
                        </div>
                        <div class="input-group">
                            <input type="number" class="cat-std" value="150" step="5">
                        </div>
                    </div>
                    <div class="category-row">
                        <div class="input-group">
                            <input type="text" value="Transportation" readonly>
                        </div>
                        <div class="input-group">
                            <input type="number" class="cat-mean" value="200" step="10">
                        </div>
                        <div class="input-group">
                            <input type="number" class="cat-std" value="80" step="5">
                        </div>
                    </div>
                    <div class="category-row">
                        <div class="input-group">
                            <input type="text" value="Entertainment" readonly>
                        </div>
                        <div class="input-group">
                            <input type="number" class="cat-mean" value="200" step="10">
                        </div>
                        <div class="input-group">
                            <input type="number" class="cat-std" value="120" step="5">
                        </div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="runForecast()">Run Forecast</button>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Running Monte Carlo simulation...</p>
            </div>

            <div class="results-section hidden" id="results">
                <h2 style="margin-bottom: 20px;">Forecast Results</h2>
                
                <div class="metrics-grid" id="metrics">
                    <!-- Metrics will be inserted here -->
                </div>

                <div class="chart-container">
                    <div id="distribution-chart"></div>
                </div>

                <div class="chart-container">
                    <div id="timeline-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function runForecast() {
            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('results').classList.add('hidden');

            // Collect input data
            const initialBalance = parseFloat(document.getElementById('initial-balance').value);
            const monthlyIncome = parseFloat(document.getElementById('monthly-income').value);
            const savingsGoal = parseFloat(document.getElementById('savings-goal').value);
            const forecastDays = parseInt(document.getElementById('forecast-days').value);

            // Collect categories
            const categoryRows = document.querySelectorAll('.category-row');
            const categories = [];
            categoryRows.forEach(row => {
                const name = row.querySelector('input[readonly]').value.toLowerCase();
                const mean = parseFloat(row.querySelectorAll('.cat-mean')[0].value);
                const std = parseFloat(row.querySelectorAll('.cat-std')[0].value);
                categories.push({ name, mean, std, alpha: 2.0, beta: 2.0 });
            });

            try {
                // Call API
                const response = await fetch('http://localhost:8000/forecast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initial_balance: initialBalance,
                        monthly_income: monthlyIncome,
                        categories: categories,
                        forecast_days: forecastDays,
                        savings_goal: savingsGoal,
                        n_simulations: 10000
                    })
                });

                const data = await response.json();

                // Display results
                displayResults(data, savingsGoal);

            } catch (error) {
                alert('Error running forecast. Make sure the API server is running on port 8000.');
                console.error(error);
            } finally {
                // Hide loading
                document.getElementById('loading').classList.remove('active');
            }
        }

        function displayResults(data, savingsGoal) {
            // Show results section
            document.getElementById('results').classList.remove('hidden');

            // Display metrics
            const metrics = [
                { title: 'Mean Balance', value: `$${data.mean_balance.toFixed(2).toLocaleString()}` },
                { title: 'Median (P50)', value: `$${data.percentile_50.toFixed(2).toLocaleString()}` },
                { title: 'Overdraft Risk', value: `${(data.overdraft_probability * 100).toFixed(1)}%` },
                { title: 'Goal Miss Risk', value: `${(data.goal_miss_probability * 100).toFixed(1)}%` }
            ];

            const metricsHtml = metrics.map(m => `
                <div class="metric-card">
                    <h3>${m.title}</h3>
                    <div class="value">${m.value}</div>
                </div>
            `).join('');
            document.getElementById('metrics').innerHTML = metricsHtml;

            // Plot distribution (simulated - would normally use actual simulation data)
            const mean = data.mean_balance;
            const std = (data.percentile_95 - data.percentile_5) / 3.29; // Approximate std from percentiles
            
            const x = [];
            const y = [];
            for (let i = mean - 3*std; i <= mean + 3*std; i += std/20) {
                x.push(i);
                y.push(Math.exp(-0.5 * Math.pow((i - mean) / std, 2)) / (std * Math.sqrt(2 * Math.PI)));
            }

            const distributionTrace = {
                x: x,
                y: y,
                type: 'scatter',
                fill: 'tozeroy',
                fillcolor: 'rgba(102, 126, 234, 0.3)',
                line: { color: '#667eea', width: 2 },
                name: 'Distribution'
            };

            const shapes = [
                {
                    type: 'line',
                    x0: data.percentile_5,
                    y0: 0,
                    x1: data.percentile_5,
                    y1: Math.max(...y),
                    line: { color: 'red', width: 2, dash: 'dash' }
                },
                {
                    type: 'line',
                    x0: data.percentile_95,
                    y0: 0,
                    x1: data.percentile_95,
                    y1: Math.max(...y),
                    line: { color: 'red', width: 2, dash: 'dash' }
                },
                {
                    type: 'line',
                    x0: data.percentile_50,
                    y0: 0,
                    x1: data.percentile_50,
                    y1: Math.max(...y),
                    line: { color: 'green', width: 3, dash: 'dash' }
                },
                {
                    type: 'line',
                    x0: savingsGoal,
                    y0: 0,
                    x1: savingsGoal,
                    y1: Math.max(...y),
                    line: { color: 'orange', width: 2, dash: 'dot' }
                }
            ];

            const distributionLayout = {
                title: 'Cashflow Distribution',
                xaxis: { title: 'Final Balance ($)' },
                yaxis: { title: 'Probability Density' },
                shapes: shapes,
                showlegend: false
            };

            Plotly.newPlot('distribution-chart', [distributionTrace], distributionLayout);

            // Plot percentile ranges
            const timelineTrace = {
                x: ['5th', '25th', '50th', '75th', '95th'],
                y: [data.percentile_5, data.percentile_25, data.percentile_50, 
                    data.percentile_75, data.percentile_95],
                type: 'bar',
                marker: {
                    color: ['#e74c3c', '#f39c12', '#2ecc71', '#f39c12', '#e74c3c']
                }
            };

            const timelineLayout = {
                title: 'Balance Distribution by Percentile',
                xaxis: { title: 'Percentile' },
                yaxis: { title: 'Balance ($)' },
                showlegend: false
            };

            Plotly.newPlot('timeline-chart', [timelineTrace], timelineLayout);
        }
    </script>
</body>
</html>
